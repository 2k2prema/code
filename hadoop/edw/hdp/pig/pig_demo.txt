-- Setting configuration at run time
set io.sort.mb 256M;

-- Create pig_demo.txt file with the following text.
This will have some text to test word count program using pig script.

This will also used to demonstrate to get started using pig in Hadoop eco system.

-- Getting started
load_data = LOAD '/user/root/pig_demo.txt';
DUMP load_data;

-- Create script pig_demo.pig
-- Launch grunt
-- Run script using "exec pig_demo.pig", one can use absolute or relative path
-- Also you can run pig scripts using "pig -f pig_demo.pig" (either by using absolute or relative path)

-- Word count program
lines = LOAD '/user/root/pig_demo.txt' AS (line:chararray);
words = FOREACH lines GENERATE FLATTEN(TOKENIZE(line)) as word;
grouped = GROUP words BY word;
wordcount = FOREACH grouped GENERATE group, COUNT(words);
DUMP wordcount;

-- Run the sqoop command, to load data into sqoop_import directory in HDFS.
sqoop import-all-tables \
  -m 1 \
  --connect "jdbc:mysql://sandbox.hortonworks.com:3306/retail_db" \
  --username=retail_dba \
  --password=hadoop \
  --warehouse-dir /user/root/sqoop_import

-- Load data into a Pig relation without a schema
departments = LOAD '/user/root/sqoop_import/departments' USING PigStorage(',');
DESCRIBE departments;

department_id = FOREACH departments GENERATE $1;
DESCRIBE department_id;

-- Cast elements in department_id to integer
department_id = FOREACH departments GENERATE (int) $1;
DESCRIBE department_id;

DUMP department_id;

-- Load data into a Pig relation with a schema
departments = LOAD '/user/root/sqoop_import/departments' USING PigStorage(',') AS (department_id:int, department_name:chararray);
DESCRIBE departments;

department_id = FOREACH departments GENERATE department_id;
DESCRIBE department_id;

DUMP department_id;

-- Load data from a Hive table into a Pig relation
-- Launch grunt using "pig -useHCatalog"
customer_details = LOAD 'xademo.customer_details' USING org.apache.hive.hcatalog.pig.HCatLoader();
DESCRIBE customer_details;
customer_details_phone_number = FOREACH customer_details GENERATE phone_number;
DUMP customer_details_phone_number;

-- Use Pig to remove records with null values from a relation
customer_details_wo_schema = LOAD '/apps/hive/warehouse/xademo.db/customer_details' USING PigStorage('|');
customer_details_not_null = FILTER customer_details_wo_schema BY ($5 is not null);
DUMP customer_details_not_null;

-- Filter with schema using positional notation
customer_details_with_schema = LOAD '/apps/hive/warehouse/xademo.db/customer_details' USING PigStorage('|') AS (phone_number: chararray,plan: chararray,rec_date: chararray,status: chararray,balance: chararray,imei: chararray,region: chararray);
customer_details_not_null = FILTER customer_details_with_schema BY ($5 is not null);
DUMP customer_details_not_null;

-- Filter with schema using name notation
customer_details_with_schema = LOAD '/apps/hive/warehouse/xademo.db/customer_details' USING PigStorage('|') AS (phone_number: chararray,plan: chararray,rec_date: chararray,status: chararray,balance: chararray,imei: chararray,region: chararray);
customer_details_not_null = FILTER customer_details_with_schema BY (imei is not null);
DUMP customer_details_not_null;

-- Filter with HCatalog
-- Launch grunt using "pig -useHCatalog"
customer_details_hive = LOAD 'xademo.customer_details' USING org.apache.hive.hcatalog.pig.HCatLoader();
customer_details_not_null = FILTER customer_details_hive BY (imei != '');
DUMP customer_details_not_null;

